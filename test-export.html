<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMH Report Export Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>TMH Report Generator Test</h1>
        
        <div class="test-section">
            <h3>Template Export Tests</h3>
            <p>Test the export functionality for both detailed and executive templates:</p>
            <button onclick="testExport('detailed')">Test Detailed Export</button>
            <button onclick="testExport('executive')">Test Executive Export</button>
            <div id="status"></div>
        </div>
        
        <div class="test-section">
            <h3>Ground Control Data Integration</h3>
            <p>Test Ground Control data processing and integration:</p>
            <button onclick="testGroundControlData()">Test Ground Control Data Processing</button>
            <div id="groundControlStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>Executive Template with Ground Control</h3>
            <p>Test executive template with Ground Control deployment metrics:</p>
            <button onclick="testExecutiveWithGroundControl()">Test Executive with Ground Control</button>
            <div id="executiveStatus"></div>
        </div>
    </div>

    <script>
        // Mock data for testing
        const mockDeviceData = {
            iosTotal: 652,
            androidTotal: 615,
            totalDevices: 1267,
            backstockTotal: 45,
            iosCompliant: 475,
            iosNonCompliant: 177,
            iosUnknown: 0,
            androidCompliant: 479,
            androidNonCompliant: 136,
            androidUnknown: 0,
            iosCompliancePercent: '72.8%',
            androidCompliancePercent: '77.9%',
            generatedDate: new Date().toLocaleString()
        };

        const mockGroundControlData = [
            {
                'Batch ID': '242428572',
                'ID': '243507603',
                'Timestamp': '7/14/25 08:45 EDT',
                'Duration (s)': '5',
                'Check out duration (s)': '1.1',
                'Launchpad': '4N Neuro',
                'Port Number': '10',
                'Launchpad version': '6.6.0',
                'Device Name': '2.42805E+13',
                'Serial#': '2.42805E+13',
                'Model': 'HC50',
                'iOS Version': '13',
                'Deployed by': 'Rule: Android - Check-Out',
                'Workflow': 'Android - Check-Out',
                'Device User': 'E034153',
                'Result': 'Deployment finished',
                'Device Checkout Status': 'Being Checked Out',
                'Device Home': '4N Neuro',
                'Device Passcode': '',
                'Friendly Name': 'Carrisa Jones',
                'Imprivata Display Name': 'Carrisa Jones',
                'Imprivata Domain': 'main.ad.tmh.org',
                'Imprivata Email': 'Carrisa.Jones@tmh.org',
                'Improper Disconnect': '',
                'List of Devices': '',
                'Manager of Device': 'Quinston.Ephraim@tmh.org',
                'Overdue device': 'No',
                'Set Device Catagory': 'Android',
                'Device Count': '11',
                'Supervisor Contact': 'Quinston.Ephraim@tmh.org'
            },
            {
                'Batch ID': '242428533',
                'ID': '243507564',
                'Timestamp': '7/14/25 08:45 EDT',
                'Duration (s)': '17',
                'Check out duration (s)': 'NA',
                'Launchpad': '7A  ADCU',
                'Port Number': '10',
                'Launchpad version': '6.6.0',
                'Device Name': '2.42855E+13',
                'Serial#': '2.42855E+13',
                'Model': 'HC50',
                'iOS Version': '13',
                'Deployed by': 'Rule: Android - Check-In',
                'Workflow': 'Android - Check-In',
                'Device User': 'E036369',
                'Result': 'Deployment finished',
                'Device Checkout Status': 'Being Checked In',
                'Device Home': '7A ADCU',
                'Device Passcode': '',
                'Friendly Name': '',
                'Imprivata Display Name': '',
                'Imprivata Domain': '',
                'Imprivata Email': '',
                'Improper Disconnect': '',
                'List of Devices': '',
                'Manager of Device': 'tessa.dooley@tmh.org',
                'Overdue device': 'No',
                'Set Device Catagory': 'Android',
                'Device Count': '10',
                'Supervisor Contact': 'tessa.dooley@tmh.org'
            },
            {
                'Batch ID': '242428529',
                'ID': '243507560',
                'Timestamp': '7/14/25 08:44 EDT',
                'Duration (s)': '60',
                'Check out duration (s)': 'NA',
                'Launchpad': '4N Neuro',
                'Port Number': '11',
                'Launchpad version': '6.6.0',
                'Device Name': '2.42805E+13',
                'Serial#': '2.42805E+13',
                'Model': 'HC50',
                'iOS Version': '13',
                'Deployed by': 'User: Michael Sanchez',
                'Workflow': 'Android - Check-In',
                'Device User': '-',
                'Result': 'Deployment failed: The device did not lock itself as expected.',
                'Device Checkout Status': 'Being Checked In',
                'Device Home': '4N Neuro',
                'Device Passcode': '',
                'Friendly Name': '',
                'Imprivata Display Name': '',
                'Imprivata Domain': '',
                'Imprivata Email': '',
                'Improper Disconnect': '',
                'List of Devices': '',
                'Manager of Device': 'Quinston.Ephraim@tmh.org',
                'Overdue device': 'No',
                'Set Device Catagory': 'Android',
                'Device Count': '11',
                'Supervisor Contact': 'Quinston.Ephraim@tmh.org'
            }
        ];

        function testExport(templateType) {
            console.log('Testing export with templateType:', templateType);
            
            try {
                // Mock the export function with proper data structure
                const reportData = {
                    ...mockDeviceData,
                    groundControlData: templateType === 'executive' ? mockGroundControlData : []
                };
                
                // Create a new document for export
                const exportDoc = document.implementation.createHTMLDocument('TMH Device Report');
                const exportBody = exportDoc.body;
                
                // Generate HTML based on template type using the actual template functions
                if (templateType === 'executive') {
                    generateExecutiveHTML(exportDoc, exportBody, reportData);
                } else {
                    generateDetailedHTML(exportDoc, exportBody, reportData);
                }
                
                // Convert to HTML string
                const htmlString = `<!DOCTYPE html>\n${exportDoc.documentElement.outerHTML}`;
                
                // Create and download the file
                const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const fileName = templateType === 'executive' ? 'TMH_Executive_Test_Report' : 'TMH_Detailed_Test_Report';
                link.download = `${fileName}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                document.getElementById('status').innerHTML = `
                    <div class="status success">
                        ✅ ${templateType === 'executive' ? 'Executive' : 'Detailed'} HTML report exported successfully!
                        <br>File: ${link.download}
                        <br>Using actual template functions for proper styling and layout.
                    </div>
                `;
                
            } catch (error) {
                console.error('Export test failed:', error);
                document.getElementById('status').innerHTML = `
                    <div class="status error">
                        ❌ Export test failed: ${error.message}
                    </div>
                `;
            }
        }

        function calculateDeploymentMetrics(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {
                    totalDeployments: 0,
                    successfulDeployments: 0,
                    failedDeployments: 0,
                    checkOutSuccess: 0,
                    checkOutTotal: 0,
                    averageCheckOutDuration: 0,
                    totalCheckOutDuration: 0,
                    successRate: 0,
                    checkOutSuccessRate: 0
                };
            }
            
            const metrics = {
                totalDeployments: data.length,
                successfulDeployments: 0,
                failedDeployments: 0,
                checkOutSuccess: 0,
                checkOutTotal: 0,
                averageCheckOutDuration: 0,
                totalCheckOutDuration: 0
            };
            
            data.forEach(record => {
                const result = record.Result ? record.Result.toString().toLowerCase() : '';
                const workflow = record.Workflow ? record.Workflow.toString().toLowerCase() : '';
                const checkOutDuration = parseFloat(record['Check out duration (s)']) || 0;
                
                // Count successful vs failed deployments
                if (result.includes('finished')) {
                    metrics.successfulDeployments++;
                } else if (result.includes('failed')) {
                    metrics.failedDeployments++;
                }
                
                // Focus only on check-out operations - this is when users actually need devices
                if (workflow.includes('check-out')) {
                    metrics.checkOutTotal++;
                    if (result.includes('finished')) {
                        metrics.checkOutSuccess++;
                        // Only count checkout duration for successful checkouts
                        if (checkOutDuration > 0) {
                            metrics.totalCheckOutDuration += checkOutDuration;
                        }
                    }
                }
            });
            
            // Calculate average checkout duration for successful checkouts only
            const successfulCheckOuts = metrics.checkOutSuccess;
            metrics.averageCheckOutDuration = successfulCheckOuts > 0 ? 
                (metrics.totalCheckOutDuration / successfulCheckOuts).toFixed(1) : 0;
            
            // Calculate success rates
            metrics.successRate = metrics.totalDeployments > 0 ? 
                ((metrics.successfulDeployments / metrics.totalDeployments) * 100).toFixed(1) : 0;
            
            // Calculate check-out success rate only - this is the key metric for user experience
            metrics.checkOutSuccessRate = metrics.checkOutTotal > 0 ? 
                ((metrics.checkOutSuccess / metrics.checkOutTotal) * 100).toFixed(1) : 0;
            
            return metrics;
        }

        function testGroundControlData() {
            try {
                console.log('Testing Ground Control data processing...');
                
                const metrics = calculateDeploymentMetrics(mockGroundControlData);
                
                document.getElementById('groundControlStatus').innerHTML = `
                    <div class="status success">
                        ✅ Ground Control data processed successfully!
                        <br>Total Deployments: ${metrics.totalDeployments}
                        <br>Successful: ${metrics.successfulDeployments}
                        <br>Failed: ${metrics.failedDeployments}
                        <br>Success Rate: ${metrics.successRate}%
                    </div>
                `;
                
            } catch (error) {
                console.error('Ground Control test failed:', error);
                document.getElementById('groundControlStatus').innerHTML = `
                    <div class="status error">
                        ❌ Ground Control test failed: ${error.message}
                    </div>
                `;
            }
        }

        function testExecutiveWithGroundControl() {
            try {
                console.log('Testing executive template with Ground Control data...');
                
                const reportData = {
                    ...mockDeviceData,
                    groundControlData: mockGroundControlData
                };
                
                const deploymentMetrics = calculateDeploymentMetrics(reportData.groundControlData);
                
                document.getElementById('executiveStatus').innerHTML = `
                    <div class="status success">
                        ✅ Executive template with Ground Control data processed successfully!
                        <br>Device Data: ${reportData.totalDevices} total devices
                        <br>Ground Control: ${deploymentMetrics.totalDeployments} deployments
                        <br>Deployment Success Rate: ${deploymentMetrics.successRate}%
                    </div>
                `;
                
            } catch (error) {
                console.error('Executive with Ground Control test failed:', error);
                document.getElementById('executiveStatus').innerHTML = `
                    <div class="status error">
                        ❌ Executive with Ground Control test failed: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 