<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>TMH Report Generator Export Test</h1>
    
    <div class="test-section">
        <h2>Test Data</h2>
        <p>This test simulates the data that would be present after processing the deviceexport.csv file.</p>
        
        <div id="testData">
            <div>iOS Total: <span id="iosTotal">245</span></div>
            <div>Android Total: <span id="androidTotal">189</span></div>
            <div>Total Devices: <span id="totalDevices">434</span></div>
            <div>Backstock Total: <span id="backstockTotal">67</span></div>
            <div>iOS Compliant: <span id="iosCompliantCount">198</span></div>
            <div>iOS Non-Compliant: <span id="iosNonCompliantCount">32</span></div>
            <div>iOS Unknown: <span id="iosUnknownCount">15</span></div>
            <div>Android Compliant: <span id="androidCompliantCount">156</span></div>
            <div>Android Non-Compliant: <span id="androidNonCompliantCount">28</span></div>
            <div>Android Unknown: <span id="androidUnknownCount">5</span></div>
            <div>iOS Compliance %: <span id="iosCompliancePercent">80.8%</span></div>
            <div>Android Compliance %: <span id="androidCompliancePercent">82.5%</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Export Test</h2>
        <button onclick="testExport('detailed')">Test Detailed Export</button>
        <button onclick="testExport('executive')">Test Executive Export</button>
        <div id="status" class="status">Ready to test exports...</div>
    </div>

    <script>
        function testExport(templateType) {
            console.log('Testing export with templateType:', templateType);
            
            // Check if any data has been uploaded and processed
            const iosTotal = parseInt(document.getElementById('iosTotal')?.textContent || '0');
            const androidTotal = parseInt(document.getElementById('androidTotal')?.textContent || '0');
            const totalDevices = parseInt(document.getElementById('totalDevices')?.textContent || '0');
            
            console.log('Current totals - iOS:', iosTotal, 'Android:', androidTotal, 'Total:', totalDevices);
            
            // If no data has been processed (all values are 0), show error
            if (iosTotal === 0 && androidTotal === 0 && totalDevices === 0) {
                document.getElementById('status').innerHTML = '❌ No data available to export. Please upload and process a device inventory file first.';
                return;
            }
            
            // Get current report data
            const reportData = getCurrentReportData();
            console.log('Report data:', reportData);
            
            // Additional validation
            if (!reportData || (reportData.iosTotal === 0 && reportData.androidTotal === 0)) {
                document.getElementById('status').innerHTML = '❌ No valid data found to export. Please ensure data has been processed correctly.';
                return;
            }

            // Create a new document for export
            const exportDoc = document.implementation.createHTMLDocument('TMH Device Report');
            
            // Create the body content
            const exportBody = exportDoc.body;
            
            // Generate HTML based on template type
            if (templateType === 'executive') {
                generateExecutiveHTML(exportDoc, exportBody, reportData);
            } else {
                generateDetailedHTML(exportDoc, exportBody, reportData);
            }
            
            // Convert to HTML string
            const htmlString = `<!DOCTYPE html>\n${exportDoc.documentElement.outerHTML}`;
            console.log('HTML string generated, length:', htmlString.length);
            
            // Create and download the file
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const fileName = templateType === 'executive' ? 'TMH_Executive_Report' : 'TMH_Device_Report';
            link.download = `${fileName}_${new Date().toISOString().split('T')[0]}.html`;
            console.log('Downloading file:', link.download);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Show success message
            const templateName = templateType === 'executive' ? 'Executive' : 'Detailed';
            document.getElementById('status').innerHTML = `✅ ${templateName} HTML report exported successfully! Open in browser and use Print to PDF for crystal clear results.`;
        }

        // Function to get current report data
        function getCurrentReportData() {
            const data = {
                iosTotal: parseInt(document.getElementById('iosTotal')?.textContent || '0'),
                androidTotal: parseInt(document.getElementById('androidTotal')?.textContent || '0'),
                totalDevices: parseInt(document.getElementById('totalDevices')?.textContent || '0'),
                backstockTotal: parseInt(document.getElementById('backstockTotal')?.textContent || '0'),
                iosCompliant: parseInt(document.getElementById('iosCompliantCount')?.textContent || '0'),
                iosNonCompliant: parseInt(document.getElementById('iosNonCompliantCount')?.textContent || '0'),
                iosUnknown: parseInt(document.getElementById('iosUnknownCount')?.textContent || '0'),
                androidCompliant: parseInt(document.getElementById('androidCompliantCount')?.textContent || '0'),
                androidNonCompliant: parseInt(document.getElementById('androidNonCompliantCount')?.textContent || '0'),
                androidUnknown: parseInt(document.getElementById('androidUnknownCount')?.textContent || '0'),
                iosCompliancePercent: document.getElementById('iosCompliancePercent')?.textContent || '0%',
                androidCompliancePercent: document.getElementById('androidCompliancePercent')?.textContent || '0%',
                generatedDate: new Date().toLocaleString()
            };
            console.log('getCurrentReportData result:', data);
            console.log('Element values - iosTotal:', document.getElementById('iosTotal')?.textContent, 'androidTotal:', document.getElementById('androidTotal')?.textContent);
            return data;
        }

        // Function to generate detailed HTML
        function generateDetailedHTML(exportDoc, exportBody, reportData) {
            console.log('Generating detailed HTML with data:', reportData);
            
            // Add template-specific styles
            const templateStyles = exportDoc.createElement('style');
            templateStyles.textContent = `
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 11px;
                    line-height: 1.2;
                    color: #333;
                    background: white;
                }
                
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 15px;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 15px;
                    padding: 10px;
                    background: linear-gradient(135deg, #2c5282, #2d3748);
                    color: white;
                    border-radius: 8px;
                }
                
                .header h1 {
                    font-size: 18px;
                    margin-bottom: 5px;
                }
                
                .header p {
                    font-size: 12px;
                    opacity: 0.9;
                }
                
                .summary-cards {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                    margin-bottom: 15px;
                }
                
                .card {
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 6px;
                    text-align: center;
                    border: 1px solid #e2e8f0;
                }
                
                .card h3 {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .card .number {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2d3748;
                }
                
                .compliance-section {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .compliance-card {
                    background: white;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 15px;
                }
                
                .compliance-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                }
                
                .compliance-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #2d3748;
                }
                
                .compliance-percentage {
                    font-size: 24px;
                    font-weight: bold;
                }
                
                .ios-percentage {
                    color: #38a169;
                }
                
                .android-percentage {
                    color: #3182ce;
                }
                
                .compliance-bars {
                    display: flex;
                    gap: 8px;
                    margin-top: 10px;
                }
                
                .compliance-item {
                    text-align: center;
                    flex: 1;
                }
                
                .compliance-item .number {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 3px;
                }
                
                .compliance-item .label {
                    font-size: 9px;
                    color: #666;
                    text-transform: uppercase;
                }
                
                .compliant { color: #38a169; }
                .non-compliant { color: #e53e3e; }
                .unknown { color: #a0aec0; }
                
                .footer {
                    text-align: center;
                    font-size: 10px;
                    color: #666;
                    margin-top: 15px;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 6px;
                }
                
                @media print {
                    body { print-color-adjust: exact; }
                    .container { padding: 10px; }
                }
            `;
            exportBody.head.appendChild(templateStyles);
            
            // Add header
            const header = exportDoc.createElement('div');
            header.className = 'header';
            header.innerHTML = `
                <h1>TMH Device Inventory Report</h1>
                <p>Tallahassee Memorial Hospital - IT Asset Management | Generated on ${reportData.generatedDate}</p>
            `;
            exportBody.appendChild(header);
            
            // Create container
            const container = exportDoc.createElement('div');
            container.className = 'container';
            
            // Add summary cards
            const summaryCards = exportDoc.createElement('div');
            summaryCards.className = 'summary-cards';
            summaryCards.innerHTML = `
                <div class="card">
                    <h3>Total iOS Devices</h3>
                    <div class="number">${reportData.iosTotal}</div>
                </div>
                <div class="card">
                    <h3>Total Android Devices</h3>
                    <div class="number">${reportData.androidTotal}</div>
                </div>
                <div class="card">
                    <h3>Total Device Count</h3>
                    <div class="number">${reportData.totalDevices}</div>
                </div>
                <div class="card">
                    <h3>Backstock Devices</h3>
                    <div class="number">${reportData.backstockTotal}</div>
                </div>
            `;
            container.appendChild(summaryCards);
            
            // Add compliance section
            const complianceSection = exportDoc.createElement('div');
            complianceSection.className = 'compliance-section';
            complianceSection.innerHTML = `
                <div class="compliance-card">
                    <div class="compliance-header">
                        <div class="compliance-title">iOS Compliance</div>
                        <div class="compliance-percentage ios-percentage">${reportData.iosCompliancePercent}</div>
                    </div>
                    <div class="compliance-bars">
                        <div class="compliance-item">
                            <div class="number compliant">${reportData.iosCompliant}</div>
                            <div class="label">Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number non-compliant">${reportData.iosNonCompliant}</div>
                            <div class="label">Non-Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number unknown">${reportData.iosUnknown}</div>
                            <div class="label">Unknown</div>
                        </div>
                    </div>
                </div>
                <div class="compliance-card">
                    <div class="compliance-header">
                        <div class="compliance-title">Android Compliance</div>
                        <div class="compliance-percentage android-percentage">${reportData.androidCompliancePercent}</div>
                    </div>
                    <div class="compliance-bars">
                        <div class="compliance-item">
                            <div class="number compliant">${reportData.androidCompliant}</div>
                            <div class="label">Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number non-compliant">${reportData.androidNonCompliant}</div>
                            <div class="label">Non-Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number unknown">${reportData.androidUnknown}</div>
                            <div class="label">Unknown</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(complianceSection);
            
            // Add footer
            const footer = exportDoc.createElement('div');
            footer.className = 'footer';
            footer.innerHTML = `
                © 2025 Tallahassee Memorial Hospital - IT Asset Management Report
            `;
            container.appendChild(footer);
            
            exportBody.appendChild(container);
            console.log('Detailed HTML generation completed');
        }

        // Function to generate executive HTML
        function generateExecutiveHTML(exportDoc, exportBody, reportData) {
            console.log('Generating executive HTML with data:', reportData);
            
            // Add template-specific styles
            const templateStyles = exportDoc.createElement('style');
            templateStyles.textContent = `
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 11px;
                    line-height: 1.3;
                    color: #333;
                    background: white;
                }
                
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 15px;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 15px;
                    padding: 10px;
                    background: linear-gradient(135deg, #2c5282, #2d3748);
                    color: white;
                    border-radius: 8px;
                }
                
                .header h1 {
                    font-size: 18px;
                    margin-bottom: 5px;
                }
                
                .header p {
                    font-size: 12px;
                    opacity: 0.9;
                }
                
                .summary-cards {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                    margin-bottom: 15px;
                }
                
                .card {
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 6px;
                    text-align: center;
                    border: 1px solid #e2e8f0;
                }
                
                .card h3 {
                    font-size: 10px;
                    color: #666;
                    margin-bottom: 5px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .card .number {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2d3748;
                }
                
                .compliance-section {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .compliance-card {
                    background: white;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 15px;
                }
                
                .compliance-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                }
                
                .compliance-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: #2d3748;
                }
                
                .compliance-percentage {
                    font-size: 24px;
                    font-weight: bold;
                }
                
                .ios-percentage {
                    color: #38a169;
                }
                
                .android-percentage {
                    color: #3182ce;
                }
                
                .compliance-bars {
                    display: flex;
                    gap: 8px;
                    margin-top: 10px;
                }
                
                .compliance-item {
                    text-align: center;
                    flex: 1;
                }
                
                .compliance-item .number {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 3px;
                }
                
                .compliance-item .label {
                    font-size: 9px;
                    color: #666;
                    text-transform: uppercase;
                }
                
                .compliant { color: #38a169; }
                .non-compliant { color: #e53e3e; }
                .unknown { color: #a0aec0; }
                
                .footer {
                    text-align: center;
                    font-size: 10px;
                    color: #666;
                    margin-top: 15px;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 6px;
                }
                
                @media print {
                    body { print-color-adjust: exact; }
                    .container { padding: 10px; }
                }
            `;
            exportBody.head.appendChild(templateStyles);
            
            // Add header
            const header = exportDoc.createElement('div');
            header.className = 'header';
            header.innerHTML = `
                <h1>TMH Executive Device Report</h1>
                <p>Tallahassee Memorial Hospital - IT Asset Management | Generated on ${reportData.generatedDate}</p>
            `;
            exportBody.appendChild(header);
            
            // Create container
            const container = exportDoc.createElement('div');
            container.className = 'container';
            
            // Add summary cards
            const summaryCards = exportDoc.createElement('div');
            summaryCards.className = 'summary-cards';
            summaryCards.innerHTML = `
                <div class="card">
                    <h3>Total iOS Devices</h3>
                    <div class="number">${reportData.iosTotal}</div>
                </div>
                <div class="card">
                    <h3>Total Android Devices</h3>
                    <div class="number">${reportData.androidTotal}</div>
                </div>
                <div class="card">
                    <h3>Total Device Count</h3>
                    <div class="number">${reportData.totalDevices}</div>
                </div>
                <div class="card">
                    <h3>Backstock Devices</h3>
                    <div class="number">${reportData.backstockTotal}</div>
                </div>
            `;
            container.appendChild(summaryCards);
            
            // Add compliance section
            const complianceSection = exportDoc.createElement('div');
            complianceSection.className = 'compliance-section';
            complianceSection.innerHTML = `
                <div class="compliance-card">
                    <div class="compliance-header">
                        <div class="compliance-title">iOS Compliance</div>
                        <div class="compliance-percentage ios-percentage">${reportData.iosCompliancePercent}</div>
                    </div>
                    <div class="compliance-bars">
                        <div class="compliance-item">
                            <div class="number compliant">${reportData.iosCompliant}</div>
                            <div class="label">Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number non-compliant">${reportData.iosNonCompliant}</div>
                            <div class="label">Non-Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number unknown">${reportData.iosUnknown}</div>
                            <div class="label">Unknown</div>
                        </div>
                    </div>
                </div>
                <div class="compliance-card">
                    <div class="compliance-header">
                        <div class="compliance-title">Android Compliance</div>
                        <div class="compliance-percentage android-percentage">${reportData.androidCompliancePercent}</div>
                    </div>
                    <div class="compliance-bars">
                        <div class="compliance-item">
                            <div class="number compliant">${reportData.androidCompliant}</div>
                            <div class="label">Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number non-compliant">${reportData.androidNonCompliant}</div>
                            <div class="label">Non-Compliant</div>
                        </div>
                        <div class="compliance-item">
                            <div class="number unknown">${reportData.androidUnknown}</div>
                            <div class="label">Unknown</div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(complianceSection);
            
            // Add footer
            const footer = exportDoc.createElement('div');
            footer.className = 'footer';
            footer.innerHTML = `
                © 2025 Tallahassee Memorial Hospital - IT Asset Management Report
            `;
            container.appendChild(footer);
            
            exportBody.appendChild(container);
            console.log('Executive HTML generation completed');
        }
    </script>
</body>
</html> 