<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMH Report Generator - Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>TMH Report Generator - Debug Test</h1>
    
    <div class="test-section">
        <h2>Live Report Generator</h2>
        <p>Use the report generator below to test all functionality:</p>
        <iframe src="report-generator.html" id="reportGeneratorFrame"></iframe>
    </div>

    <div class="test-section">
        <h2>Functionality Tests</h2>
        <button onclick="testExportFunctions()">Test Export Functions</button>
        <button onclick="testGroundControlProcessing()">Test Ground Control Processing</button>
        <button onclick="testTemplateGeneration()">Test Template Generation</button>
        <button onclick="testDataProcessing()">Test Data Processing</button>
        <button onclick="testFileUploads()">Test File Uploads</button>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Console Log</h2>
        <div id="consoleLog" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        // Mock data for testing
        const mockDeviceData = [
            {
                deviceName: 'Test iPhone',
                operatingSystem: 'iOS 18.3.2',
                model: 'iPhone 15',
                deviceCategoryKey: 'Epic Welcome',
                complianceState: 'compliant'
            },
            {
                deviceName: 'Test Android',
                operatingSystem: 'Android 13',
                model: 'Samsung Galaxy',
                deviceCategoryKey: 'HC50 Zebra',
                complianceState: 'nonCompliant'
            }
        ];

        const mockGroundControlData = [
            {
                'Result': 'Finished',
                'Workflow': 'Check-Out',
                'Duration (s)': '45.2'
            },
            {
                'Result': 'Failed',
                'Workflow': 'Check-In',
                'Duration (s)': '12.8'
            }
        ];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        function addTestResult(message, passed) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function getFrameWindow() {
            const iframe = document.getElementById('reportGeneratorFrame');
            try {
                // Try to access the frame window
                const frameWindow = iframe.contentWindow;
                if (frameWindow) {
                    return frameWindow;
                }
            } catch (error) {
                log(`Cross-origin access blocked: ${error.message}`);
                return null;
            }
            return null;
        }

        function testExportFunctions() {
            log('Testing export functions...');
            
            try {
                const frameWindow = getFrameWindow();
                
                if (!frameWindow) {
                    addTestResult('⚠ Cross-origin access blocked - cannot test frame functions directly', false);
                    log('Cross-origin access blocked - testing local export capabilities instead');
                    
                    // Test local export capabilities
                    try {
                        const testDoc = document.implementation.createHTMLDocument('Test');
                        const testBlob = new Blob(['<html><body>Test</body></html>'], { type: 'text/html' });
                        const testUrl = URL.createObjectURL(testBlob);
                        URL.revokeObjectURL(testUrl);
                        
                        addTestResult('✓ Local HTML export capabilities work', true);
                        log('Local HTML export capabilities verified');
                    } catch (localError) {
                        addTestResult(`✗ Local export test failed: ${localError.message}`, false);
                        log(`ERROR: Local export test failed - ${localError.message}`);
                    }
                    return;
                }
                
                // Test if export functions exist in the frame
                if (typeof frameWindow.exportToHTML === 'function') {
                    addTestResult('✓ Export function exists in report generator', true);
                    log('Export function found in report generator');
                } else {
                    addTestResult('✗ Export function not found in report generator', false);
                    log('ERROR: Export function not found in report generator');
                }

                // Test if template generation functions exist
                if (typeof frameWindow.generateDetailedHTML === 'function') {
                    addTestResult('✓ Detailed template function exists in report generator', true);
                    log('Detailed template function found in report generator');
                } else {
                    addTestResult('✗ Detailed template function not found in report generator', false);
                    log('ERROR: Detailed template function not found in report generator');
                }

                if (typeof frameWindow.generateExecutiveHTML === 'function') {
                    addTestResult('✓ Executive template function exists in report generator', true);
                    log('Executive template function found in report generator');
                } else {
                    addTestResult('✗ Executive template function not found in report generator', false);
                    log('ERROR: Executive template function not found in report generator');
                }

            } catch (error) {
                addTestResult(`✗ Export test failed: ${error.message}`, false);
                log(`ERROR: Export test failed - ${error.message}`);
            }
        }

        function testGroundControlProcessing() {
            log('Testing Ground Control processing...');
            
            try {
                const frameWindow = getFrameWindow();
                
                if (!frameWindow) {
                    addTestResult('⚠ Cross-origin access blocked - testing local Ground Control processing', false);
                    log('Cross-origin access blocked - testing local Ground Control processing');
                    
                    // Test local Ground Control processing
                    try {
                        const localMetrics = calculateLocalDeploymentMetrics(mockGroundControlData);
                        if (localMetrics && typeof localMetrics.totalDeployments === 'number') {
                            addTestResult('✓ Local Ground Control metrics calculation works', true);
                            log(`Local Ground Control metrics calculated: ${JSON.stringify(localMetrics)}`);
                        } else {
                            addTestResult('✗ Local Ground Control metrics calculation failed', false);
                            log('ERROR: Local Ground Control metrics calculation failed');
                        }
                    } catch (localError) {
                        addTestResult(`✗ Local Ground Control test failed: ${localError.message}`, false);
                        log(`ERROR: Local Ground Control test failed - ${localError.message}`);
                    }
                    return;
                }
                
                // Test if Ground Control functions exist in the frame
                if (typeof frameWindow.calculateDeploymentMetrics === 'function') {
                    addTestResult('✓ Ground Control metrics function exists in report generator', true);
                    log('Ground Control metrics function found in report generator');
                    
                    // Test metrics calculation
                    const metrics = frameWindow.calculateDeploymentMetrics(mockGroundControlData);
                    if (metrics && typeof metrics.totalDeployments === 'number') {
                        addTestResult('✓ Ground Control metrics calculation works', true);
                        log(`Ground Control metrics calculated: ${JSON.stringify(metrics)}`);
                    } else {
                        addTestResult('✗ Ground Control metrics calculation failed', false);
                        log('ERROR: Ground Control metrics calculation failed');
                    }
                } else {
                    addTestResult('✗ Ground Control metrics function not found in report generator', false);
                    log('ERROR: Ground Control metrics function not found in report generator');
                }

                if (typeof frameWindow.processGroundControlData === 'function') {
                    addTestResult('✓ Ground Control processing function exists in report generator', true);
                    log('Ground Control processing function found in report generator');
                } else {
                    addTestResult('✗ Ground Control processing function not found in report generator', false);
                    log('ERROR: Ground Control processing function not found in report generator');
                }

            } catch (error) {
                addTestResult(`✗ Ground Control test failed: ${error.message}`, false);
                log(`ERROR: Ground Control test failed - ${error.message}`);
            }
        }

        function testTemplateGeneration() {
            log('Testing template generation...');
            
            try {
                // Test if we can create a document for export
                const exportDoc = document.implementation.createHTMLDocument('Test');
                if (exportDoc && exportDoc.head) {
                    addTestResult('✓ Document creation works', true);
                    log('Document creation successful');
                } else {
                    addTestResult('✗ Document creation failed', false);
                    log('ERROR: Document creation failed');
                }

                // Test if template styles can be added
                const templateStyles = exportDoc.createElement('style');
                templateStyles.textContent = 'body { font-family: Arial; }';
                exportDoc.head.appendChild(templateStyles);
                
                if (exportDoc.head.querySelector('style')) {
                    addTestResult('✓ Template styles can be added', true);
                    log('Template styles added successfully');
                } else {
                    addTestResult('✗ Template styles failed to add', false);
                    log('ERROR: Template styles failed to add');
                }

                // Test if we can access the frame's template functions
                const frameWindow = getFrameWindow();
                if (!frameWindow) {
                    addTestResult('⚠ Cross-origin access blocked - template functions not accessible from frame', false);
                    log('Cross-origin access blocked - template functions not accessible from frame');
                } else if (typeof frameWindow.generateDetailedHTML === 'function') {
                    addTestResult('✓ Template generation functions accessible from frame', true);
                    log('Template generation functions accessible from frame');
                } else {
                    addTestResult('✗ Template generation functions not accessible from frame', false);
                    log('ERROR: Template generation functions not accessible from frame');
                }

            } catch (error) {
                addTestResult(`✗ Template generation test failed: ${error.message}`, false);
                log(`ERROR: Template generation test failed - ${error.message}`);
            }
        }

        function testDataProcessing() {
            log('Testing data processing...');
            
            try {
                const frameWindow = getFrameWindow();
                
                if (!frameWindow) {
                    addTestResult('⚠ Cross-origin access blocked - cannot test frame data processing functions', false);
                    log('Cross-origin access blocked - testing local data processing capabilities');
                    
                    // Test local data processing capabilities
                    try {
                        // Test CSV parsing
                        const testCSV = 'deviceName,operatingSystem,model\nTest Device,iOS 18,iPhone 15';
                        const testLines = testCSV.split('\n');
                        if (testLines.length > 0) {
                            addTestResult('✓ Local CSV parsing capabilities work', true);
                            log('Local CSV parsing capabilities verified');
                        } else {
                            addTestResult('✗ Local CSV parsing failed', false);
                            log('ERROR: Local CSV parsing failed');
                        }
                    } catch (localError) {
                        addTestResult(`✗ Local data processing test failed: ${localError.message}`, false);
                        log(`ERROR: Local data processing test failed - ${localError.message}`);
                    }
                    return;
                }
                
                // Test if data processing functions exist in the frame
                if (typeof frameWindow.processDeviceData === 'function') {
                    addTestResult('✓ Device data processing function exists in report generator', true);
                    log('Device data processing function found in report generator');
                } else {
                    addTestResult('✗ Device data processing function not found in report generator', false);
                    log('ERROR: Device data processing function not found in report generator');
                }

                // Test if column mapping functions exist
                if (typeof frameWindow.mapIntuneColumns === 'function') {
                    addTestResult('✓ Intune column mapping function exists in report generator', true);
                    log('Intune column mapping function found in report generator');
                } else {
                    addTestResult('✗ Intune column mapping function not found in report generator', false);
                    log('ERROR: Intune column mapping function not found in report generator');
                }

                if (typeof frameWindow.mapGroundControlColumns === 'function') {
                    addTestResult('✓ Ground Control column mapping function exists in report generator', true);
                    log('Ground Control column mapping function found in report generator');
                } else {
                    addTestResult('✗ Ground Control column mapping function not found in report generator', false);
                    log('ERROR: Ground Control column mapping function not found in report generator');
                }

            } catch (error) {
                addTestResult(`✗ Data processing test failed: ${error.message}`, false);
                log(`ERROR: Data processing test failed - ${error.message}`);
            }
        }

        function testFileUploads() {
            log('Testing file upload functionality...');
            
            try {
                const frameWindow = getFrameWindow();
                
                if (!frameWindow) {
                    addTestResult('⚠ Cross-origin access blocked - cannot test frame file upload elements', false);
                    log('Cross-origin access blocked - testing local file upload capabilities');
                    
                    // Test local file upload capabilities
                    try {
                        // Test if File API is available
                        if (typeof File !== 'undefined' && typeof FileReader !== 'undefined') {
                            addTestResult('✓ Local file upload APIs are available', true);
                            log('Local file upload APIs verified');
                        } else {
                            addTestResult('✗ Local file upload APIs not available', false);
                            log('ERROR: Local file upload APIs not available');
                        }
                    } catch (localError) {
                        addTestResult(`✗ Local file upload test failed: ${localError.message}`, false);
                        log(`ERROR: Local file upload test failed - ${localError.message}`);
                    }
                    return;
                }
                
                const frameDocument = frameWindow.document;
                
                // Test if file input elements exist
                const fileInput = frameDocument.getElementById('fileInput');
                const groundControlFileInput = frameDocument.getElementById('groundControlFileInput');
                
                if (fileInput) {
                    addTestResult('✓ Intune file input element exists', true);
                    log('Intune file input element found');
                } else {
                    addTestResult('✗ Intune file input element not found', false);
                    log('ERROR: Intune file input element not found');
                }
                
                if (groundControlFileInput) {
                    addTestResult('✓ Ground Control file input element exists', true);
                    log('Ground Control file input element found');
                } else {
                    addTestResult('✗ Ground Control file input element not found', false);
                    log('ERROR: Ground Control file input element not found');
                }
                
                // Test if upload areas exist
                const uploadAreas = frameDocument.querySelectorAll('.upload-area');
                if (uploadAreas.length >= 2) {
                    addTestResult('✓ Upload areas exist and properly styled', true);
                    log(`Found ${uploadAreas.length} upload areas`);
                } else {
                    addTestResult('✗ Upload areas not found or incomplete', false);
                    log('ERROR: Upload areas not found or incomplete');
                }
                
                // Test if status messages exist
                const statusMessages = frameDocument.querySelectorAll('.status-message');
                if (statusMessages.length >= 2) {
                    addTestResult('✓ Status message elements exist', true);
                    log(`Found ${statusMessages.length} status message elements`);
                } else {
                    addTestResult('✗ Status message elements not found', false);
                    log('ERROR: Status message elements not found');
                }

            } catch (error) {
                addTestResult(`✗ File upload test failed: ${error.message}`, false);
                log(`ERROR: File upload test failed - ${error.message}`);
            }
        }

        // Local Ground Control processing function for testing when frame access is blocked
        function calculateLocalDeploymentMetrics(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {
                    totalDeployments: 0,
                    successfulDeployments: 0,
                    failedDeployments: 0,
                    successRate: 0
                };
            }
            
            const metrics = {
                totalDeployments: data.length,
                successfulDeployments: 0,
                failedDeployments: 0
            };
            
            data.forEach(record => {
                const result = record.Result ? record.Result.toString().toLowerCase() : '';
                if (result.includes('finished')) {
                    metrics.successfulDeployments++;
                } else if (result.includes('failed')) {
                    metrics.failedDeployments++;
                }
            });
            
            metrics.successRate = metrics.totalDeployments > 0 ? 
                ((metrics.successfulDeployments / metrics.totalDeployments) * 100).toFixed(1) : 0;
            
            return metrics;
        }

        // Initialize test page
        log('Debug test page loaded');
        log('Report generator iframe loaded - ready to test functions');
        
        // Wait for iframe to load
        document.getElementById('reportGeneratorFrame').onload = function() {
            log('Report generator iframe loaded successfully');
            log('All functions should now be accessible for testing');
        };
    </script>
</body>
</html> 